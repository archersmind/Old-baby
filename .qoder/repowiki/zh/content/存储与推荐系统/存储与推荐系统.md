# 存储与推荐系统

<cite>
**本文档引用的文件**
- [app.js](file://app.js)
- [storage.js](file://utils/storage.js)
- [recommend.js](file://utils/recommend.js)
- [util.js](file://utils/util.js)
- [recipes.json](file://data/recipes.json)
- [diseases.json](file://data/diseases.json)
- [allergens.json](file://data/allergens.json)
- [breeds.json](file://data/breeds.json)
- [pet-profile.js](file://pages/pet-profile/pet-profile.js)
- [recipe-list.js](file://pages/recipe-list/recipe-list.js)
- [my.js](file://pages/my/my.js)
- [index.js](file://pages/index/index.js)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介

Old-baby是一个专为老年犬主人设计的自制狗粮指南小程序，采用微信小程序框架开发。该项目实现了完整的宠物信息存储管理和智能食谱推荐系统，为用户提供个性化的老年犬护理解决方案。

系统的核心功能包括：
- **本地数据存储**：实现宠物信息的完整CRUD操作和状态管理
- **智能推荐算法**：基于宠物健康状况提供个性化食谱推荐
- **通用工具函数**：提供格式化、验证、交互等基础功能
- **数据驱动开发**：通过JSON数据文件实现灵活的内容管理

## 项目结构

项目采用模块化组织结构，主要分为以下几个层次：

```mermaid
graph TB
subgraph "应用层"
APP[App.js 应用入口]
PAGES[页面组件]
end
subgraph "工具层"
UTIL[工具函数]
STORAGE[存储管理]
RECOMMEND[推荐算法]
end
subgraph "数据层"
RECIPES[食谱数据]
DISEASES[疾病数据]
ALLERGENS[过敏原数据]
BREEDS[品种数据]
end
subgraph "页面组件"
INDEX[首页]
PET_PROFILE[宠物档案]
RECIPE_LIST[食谱列表]
RECIPE_DETAIL[食谱详情]
MY[我的页面]
end
APP --> UTIL
APP --> STORAGE
APP --> RECOMMEND
PAGES --> PET_PROFILE
PAGES --> RECIPE_LIST
PAGES --> INDEX
PAGES --> MY
STORAGE --> RECIPES
STORAGE --> DISEASES
STORAGE --> ALLERGENS
STORAGE --> BREEDS
RECOMMEND --> RECIPES
RECOMMEND --> DISEASES
RECOMMEND --> ALLERGENS
```

**图表来源**
- [app.js](file://app.js#L1-L21)
- [storage.js](file://utils/storage.js#L1-L155)
- [recommend.js](file://utils/recommend.js#L1-L109)

**章节来源**
- [app.js](file://app.js#L1-L21)
- [storage.js](file://utils/storage.js#L1-L155)
- [recommend.js](file://utils/recommend.js#L1-L109)

## 核心组件

### 数据存储系统

系统采用微信小程序的本地存储API实现数据持久化，支持以下核心功能：

- **宠物信息管理**：完整的CRUD操作
- **当前宠物状态**：记录用户当前选中的宠物
- **用户信息存储**：保存用户的基本信息
- **数据类型安全**：确保数据格式的一致性和完整性

### 智能推荐引擎

基于机器学习原理的食谱推荐算法，主要特征包括：

- **疾病匹配**：根据宠物的健康状况进行精准匹配
- **过敏原避免**：自动过滤宠物过敏的食物成分
- **难度筛选**：考虑制作复杂度的实用性
- **评分机制**：量化推荐结果的质量

### 通用工具库

提供开发中常用的基础功能：

- **时间格式化**：统一的时间显示格式
- **年龄描述**：根据年龄自动分类
- **营养计算**：基础代谢率和喂食量估算
- **UI交互**：加载提示、确认对话框等

**章节来源**
- [storage.js](file://utils/storage.js#L1-L155)
- [recommend.js](file://utils/recommend.js#L1-L109)
- [util.js](file://utils/util.js#L1-L123)

## 架构概览

系统采用分层架构设计，各层职责明确，耦合度低：

```mermaid
graph TD
subgraph "表现层"
UI[用户界面]
PAGE[页面组件]
end
subgraph "业务逻辑层"
SERVICE[业务服务]
VALIDATION[数据验证]
FILTERING[数据过滤]
end
subgraph "数据访问层"
STORAGE[本地存储]
CACHE[内存缓存]
end
subgraph "数据源"
JSON[JSON配置文件]
WECHAT[微信API]
end
UI --> PAGE
PAGE --> SERVICE
SERVICE --> VALIDATION
SERVICE --> FILTERING
SERVICE --> STORAGE
STORAGE --> CACHE
STORAGE --> JSON
STORAGE --> WECHAT
```

**图表来源**
- [storage.js](file://utils/storage.js#L1-L155)
- [recommend.js](file://utils/recommend.js#L1-L109)
- [util.js](file://utils/util.js#L1-L123)

### 数据流图

```mermaid
sequenceDiagram
participant User as 用户
participant Page as 页面组件
participant Storage as 存储模块
participant Recommend as 推荐算法
participant Data as 数据源
User->>Page : 选择宠物
Page->>Storage : 获取当前宠物
Storage->>Data : 读取本地存储
Data-->>Storage : 返回宠物数据
Storage-->>Page : 返回当前宠物
User->>Page : 搜索食谱
Page->>Recommend : 计算推荐分数
Recommend->>Data : 加载食谱数据
Data-->>Recommend : 返回食谱列表
Recommend->>Recommend : 过滤过敏原
Recommend->>Recommend : 匹配疾病
Recommend->>Recommend : 计算难度权重
Recommend-->>Page : 返回推荐结果
Page-->>User : 显示食谱列表
```

**图表来源**
- [recipe-list.js](file://pages/recipe-list/recipe-list.js#L30-L48)
- [recommend.js](file://utils/recommend.js#L10-L66)

## 详细组件分析

### 存储管理系统

#### 数据模型设计

系统采用扁平化数据结构，确保数据的可访问性和一致性：

```mermaid
erDiagram
PET {
string id PK
string name
string avatar
string breed
string breedName
number age
number weight
string gender
boolean neutered
array diseases
string medications
string activityLevel
array allergens
string preferences
string currentDiet
array reports
number createTime
number updateTime
}
RECIPE {
string id PK
string name
string description
array suitableFor
array avoidFor
string difficulty
string prepTime
string servings
string calories
string image
array ingredients
array steps
object nutrition
array tips
array warnings
}
DISEASE {
string id PK
string name
string category
string description
string dietTips
}
ALLERGEN {
string id PK
string name
string category
}
```

**图表来源**
- [storage.js](file://utils/storage.js#L52-L77)
- [recipes.json](file://data/recipes.json#L1-L515)
- [diseases.json](file://data/diseases.json#L1-L108)
- [allergens.json](file://data/allergens.json#L1-L15)

#### CRUD操作流程

```mermaid
flowchart TD
START([开始操作]) --> CHECK_TYPE{"操作类型"}
CHECK_TYPE --> |获取列表| GET_LIST[获取宠物列表]
CHECK_TYPE --> |添加宠物| ADD_PET[添加新宠物]
CHECK_TYPE --> |更新宠物| UPDATE_PET[更新宠物信息]
CHECK_TYPE --> |删除宠物| DELETE_PET[删除宠物]
CHECK_TYPE --> |获取详情| GET_DETAIL[获取宠物详情]
GET_LIST --> LOAD_STORAGE[从本地存储加载]
LOAD_STORAGE --> RETURN_LIST[返回宠物列表]
ADD_PET --> VALIDATE_DATA[验证输入数据]
VALIDATE_DATA --> GENERATE_ID[生成唯一ID]
GENERATE_ID --> CREATE_PET[创建宠物对象]
CREATE_PET --> SAVE_STORAGE[保存到本地存储]
SAVE_STORAGE --> RETURN_PET[返回新宠物]
UPDATE_PET --> FIND_PET[查找目标宠物]
FIND_PET --> UPDATE_FIELDS[更新指定字段]
UPDATE_FIELDS --> SAVE_STORAGE
SAVE_STORAGE --> RETURN_PET
DELETE_PET --> FILTER_PETS[过滤宠物列表]
FILTER_PETS --> SAVE_STORAGE
SAVE_STORAGE --> RETURN_TRUE[返回成功]
GET_DETAIL --> FIND_PET
FIND_PET --> RETURN_PET
RETURN_LIST --> END([结束])
RETURN_PET --> END
RETURN_TRUE --> END
```

**图表来源**
- [storage.js](file://utils/storage.js#L19-L108)

#### 状态管理机制

系统通过全局状态管理实现跨页面的数据共享：

```mermaid
stateDiagram-v2
[*] --> 初始化
初始化 --> 检查存储 : 应用启动
检查存储 --> 存储存在 : 已有数据
检查存储 --> 创建默认 : 首次使用
存储存在 --> 等待操作
创建默认 --> 等待操作
等待操作 --> 添加宠物 : 用户添加
等待操作 --> 更新宠物 : 用户修改
等待操作 --> 删除宠物 : 用户删除
等待操作 --> 切换宠物 : 用户选择
添加宠物 --> 保存数据
更新宠物 --> 保存数据
删除宠物 --> 保存数据
切换宠物 --> 保存状态
保存数据 --> 等待操作
保存状态 --> 等待操作
```

**图表来源**
- [app.js](file://app.js#L8-L14)
- [storage.js](file://utils/storage.js#L113-L140)

**章节来源**
- [storage.js](file://utils/storage.js#L1-L155)
- [app.js](file://app.js#L1-L21)

### 智能推荐算法

#### 推荐算法架构

推荐系统采用多因子评分机制，综合考虑多个维度：

```mermaid
flowchart LR
INPUT[宠物输入信息] --> PREPROCESS[数据预处理]
PREPROCESS --> DISEASE_MATCH[疾病匹配]
PREPROCESS --> ALLERGEN_FILTER[过敏原过滤]
PREPROCESS --> DIFFICULTY_WEIGHT[难度权重]
DISEASE_MATCH --> SCORE_CALC[分数计算]
ALLERGEN_FILTER --> SCORE_CALC
DIFFICULTY_WEIGHT --> SCORE_CALC
SCORE_CALC --> SORTING[结果排序]
SORTING --> OUTPUT[推荐食谱列表]
```

**图表来源**
- [recommend.js](file://utils/recommend.js#L10-L66)

#### 疾病匹配机制

算法通过精确匹配宠物的疾病标签来计算相关性分数：

```mermaid
sequenceDiagram
participant Pet as 宠物信息
participant Recipe as 食谱
participant Algorithm as 推荐算法
Pet->>Algorithm : 提供疾病列表
Recipe->>Algorithm : 提供适用疾病列表
Algorithm->>Algorithm : 比较疾病ID
Algorithm->>Algorithm : 计算匹配分数
Algorithm->>Algorithm : 累加权重
Algorithm-->>Recipe : 返回匹配度分数
```

**图表来源**
- [recommend.js](file://utils/recommend.js#L32-L45)

#### 过敏原避免策略

系统采用严格的过敏原过滤机制：

```mermaid
flowchart TD
PET_ALLERGENS[宠物过敏原列表] --> CHECK_ALLERGENS{是否存在过敏原}
CHECK_ALLERGENS --> |否| ALLOW_RECIPE[允许该食谱]
CHECK_ALLERGENS --> |是| COMPARE_INGREDIENTS[比较食材]
COMPARE_INGREDIENTS --> HAS_ALLERGEN{包含过敏原?}
HAS_ALLERGEN --> |是| FILTER_OUT[过滤掉食谱]
HAS_ALLERGEN --> |否| ALLOW_RECIPE
ALLOW_RECIPE --> CALCULATE_SCORE[计算最终分数]
FILTER_OUT --> NEXT_RECIPE[检查下一个食谱]
NEXT_RECIPE --> CHECK_ALLERGENS
```

**图表来源**
- [recommend.js](file://utils/recommend.js#L24-L30)

#### 难度筛选机制

考虑到老年犬的特殊需求，系统优先推荐制作简单的食谱：

```mermaid
flowchart LR
RECIPE[食谱] --> CHECK_DIFFICULTY{难度等级}
CHECK_DIFFICULTY --> |简单| ADD_BONUS[+2分]
CHECK_DIFFICULTY --> |中等| NO_BONUS[0分]
CHECK_DIFFICULTY --> |困难| PENALTY[-1分]
ADD_BONUS --> FINAL_SCORE[最终分数]
NO_BONUS --> FINAL_SCORE
PENALTY --> FINAL_SCORE
```

**图表来源**
- [recommend.js](file://utils/recommend.js#L47-L50)

**章节来源**
- [recommend.js](file://utils/recommend.js#L1-L109)
- [recipes.json](file://data/recipes.json#L1-L515)

### 通用工具函数

#### 时间处理工具

提供统一的时间格式化功能：

```mermaid
classDiagram
class TimeUtils {
+formatTime(date) string
+formatNumber(n) string
}
class AgeCalculator {
+getAgeDescription(age) string
}
class FoodCalculator {
+calculateDailyFood(weight, activityLevel) number
}
TimeUtils --> AgeCalculator : "辅助计算"
AgeCalculator --> FoodCalculator : "使用年龄描述"
```

**图表来源**
- [util.js](file://utils/util.js#L6-L54)

#### UI交互工具

提供丰富的用户界面交互功能：

```mermaid
sequenceDiagram
participant Component as 组件
participant Util as 工具函数
participant WeChat as 微信API
Component->>Util : showLoading()
Util->>WeChat : wx.showLoading()
WeChat-->>Util : 显示加载动画
Util-->>Component : 加载完成
Component->>Util : showToast()
Util->>WeChat : wx.showToast()
WeChat-->>Util : 显示提示消息
Util-->>Component : 提示完成
Component->>Util : showConfirm()
Util->>WeChat : wx.showModal()
WeChat-->>Util : 返回用户选择
Util-->>Component : 处理确认结果
```

**图表来源**
- [util.js](file://utils/util.js#L72-L110)

**章节来源**
- [util.js](file://utils/util.js#L1-L123)

## 依赖关系分析

系统采用模块化设计，各组件间依赖关系清晰：

```mermaid
graph TB
subgraph "核心模块"
STORAGE[storage.js]
RECOMMEND[recommend.js]
UTIL[util.js]
end
subgraph "数据模块"
RECIPES[recipes.json]
DISEASES[diseases.json]
ALLERGENS[allergens.json]
BREEDS[breeds.json]
end
subgraph "页面模块"
INDEX_PAGE[index.js]
PET_PAGE[pet-profile.js]
RECIPE_PAGE[recipe-list.js]
MY_PAGE[my.js]
end
STORAGE --> RECIPES
STORAGE --> DISEASES
STORAGE --> ALLERGENS
STORAGE --> BREEDS
RECOMMEND --> RECIPES
RECOMMEND --> DISEASES
RECOMMEND --> ALLERGENS
PET_PAGE --> STORAGE
PET_PAGE --> UTIL
PET_PAGE --> BREEDS
RECIPE_PAGE --> STORAGE
RECIPE_PAGE --> RECOMMEND
RECIPE_PAGE --> DISEASES
INDEX_PAGE --> STORAGE
INDEX_PAGE --> UTIL
MY_PAGE --> STORAGE
MY_PAGE --> UTIL
```

**图表来源**
- [storage.js](file://utils/storage.js#L1-L155)
- [recommend.js](file://utils/recommend.js#L1-L109)
- [util.js](file://utils/util.js#L1-L123)

### 数据依赖关系

```mermaid
erDiagram
PET ||--o{ RECIPE : "疾病匹配"
PET ||--o{ RECIPE : "过敏原避免"
PET ||--|| RECIPE : "活动水平"
DISEASE ||--o{ RECIPE : "适用范围"
ALLERGEN ||--o{ RECIPE : "避免成分"
BREED ||--|| PET : "品种信息"
```

**图表来源**
- [storage.js](file://utils/storage.js#L67-L76)
- [recommend.js](file://utils/recommend.js#L32-L45)

**章节来源**
- [storage.js](file://utils/storage.js#L1-L155)
- [recommend.js](file://utils/recommend.js#L1-L109)

## 性能考虑

### 存储性能优化

1. **批量操作**：所有CRUD操作都通过批量处理减少存储调用次数
2. **内存缓存**：热门数据在内存中缓存，减少重复读取
3. **延迟加载**：非关键数据采用延迟加载策略

### 推荐算法优化

1. **索引优化**：使用数组索引快速查找疾病和过敏原
2. **早期过滤**：优先过滤明显不合适的食谱
3. **增量计算**：只对变化的数据重新计算分数

### 内存管理

1. **及时释放**：页面切换时及时清理不需要的数据
2. **数据压缩**：对大型数据结构进行压缩存储
3. **懒加载**：按需加载页面组件和数据

## 故障排除指南

### 常见问题及解决方案

#### 数据丢失问题

**问题现象**：宠物信息无法保存或丢失

**可能原因**：
- 本地存储空间不足
- 权限被拒绝
- 数据格式错误

**解决步骤**：
1. 检查设备存储空间
2. 重新授权存储权限
3. 验证数据格式正确性
4. 清理缓存后重试

#### 推荐结果异常

**问题现象**：食谱推荐不符合预期

**可能原因**：
- 疾病标签不匹配
- 过敏原数据缺失
- 推荐权重设置不当

**解决步骤**：
1. 检查宠物健康信息完整性
2. 验证过敏原列表准确性
3. 调整推荐参数
4. 清除推荐缓存

#### 页面加载缓慢

**问题现象**：页面响应速度慢

**可能原因**：
- 数据量过大
- 网络请求阻塞
- 组件渲染复杂

**解决步骤**：
1. 优化数据结构
2. 实现分页加载
3. 减少不必要的渲染
4. 使用虚拟滚动

**章节来源**
- [storage.js](file://utils/storage.js#L20-L38)
- [recommend.js](file://utils/recommend.js#L10-L66)

## 结论

Old-baby项目的存储管理和智能推荐系统展现了优秀的软件工程实践：

### 技术优势

1. **模块化设计**：清晰的分层架构便于维护和扩展
2. **数据驱动**：通过JSON配置实现灵活的内容管理
3. **用户体验**：简洁直观的操作界面和流畅的交互体验
4. **性能优化**：合理的缓存策略和异步处理机制

### 扩展建议

1. **数据库迁移**：考虑引入云数据库支持多设备同步
2. **AI增强**：集成机器学习算法提升推荐精度
3. **实时同步**：实现云端数据备份和恢复
4. **API接口**：提供标准化的RESTful API便于第三方集成

该项目为老年犬护理领域提供了一个完整、实用的数字化解决方案，体现了技术服务于健康的宗旨。

## 附录

### API接口规范

#### 存储管理API

| 接口 | 方法 | 参数 | 返回值 | 描述 |
|------|------|------|--------|------|
| getPets | GET | 无 | Array | 获取所有宠物列表 |
| getPetById | GET | id: string | Object | 根据ID获取宠物详情 |
| addPet | POST | petData: Object | Object | 添加新宠物 |
| updatePet | PUT | id: string, updateData: Object | Object | 更新宠物信息 |
| deletePet | DELETE | id: string | boolean | 删除指定宠物 |
| getCurrentPet | GET | 无 | Object | 获取当前选中宠物 |
| setCurrentPetId | POST | id: string | boolean | 设置当前宠物ID |

#### 推荐算法API

| 接口 | 方法 | 参数 | 返回值 | 描述 |
|------|------|------|--------|------|
| getRecommendedRecipes | GET | pet: Object | Array | 获取推荐食谱列表 |
| getAllRecipes | GET | 无 | Array | 获取所有食谱 |
| getRecipeById | GET | id: string | Object | 根据ID获取食谱详情 |
| getRecipesByDisease | GET | diseaseId: string | Array | 根据疾病获取食谱 |
| searchRecipes | GET | keyword: string | Array | 搜索食谱 |

### 错误处理机制

系统采用统一的错误处理策略：

1. **存储错误**：捕获存储异常并记录日志
2. **网络错误**：提供重试机制和降级策略
3. **数据验证**：实时验证用户输入的有效性
4. **异常恢复**：自动恢复到安全状态

### 最佳实践

1. **数据一致性**：确保所有操作的原子性和一致性
2. **性能监控**：持续监控系统性能指标
3. **用户反馈**：建立有效的用户反馈收集机制
4. **安全防护**：实施必要的数据安全和隐私保护措施